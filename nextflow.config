cleanup = true

plugins {
    id 'nf-weblog@1.1.2'
}

process {
  
  containerOptions = { 
    workflow.containerEngine == "singularity" ? '--nv': ( workflow.containerEngine == "docker" ? ' --runtime=nvidia --gpus "device=${CUDA_VISIBLE_DEVICES:-0}"' : null )       
  }
  
  
  withLabel: with_gpu {
    maxForks = 1
    clusterOptions = { 
      process.executor == "sge" ? '-l gpu=1': ( process.executor == "slurm" ? "--gres gpu:1": null )       
    }
  }
}

params {
	nthreads = 2
	spk_id_min_prosterior = 0.5
  acoustic_model = "cnn_tdnn_1d_online"  
}

process.executor = 'local'
docker.enabled = false            

env {
    KALDI_ROOT = "/opt/kaldi"
    FAIRSEQ_ROOT = "/opt/fairseq"    
    ET_G2P_ROOT = "/opt/et-g2p"
    PATH = "/root/miniconda3/bin:$PATH"  
    LD_LIBRARY_PATH = "/usr/local/nvidia/lib:/usr/local/nvidia/lib64"  
}

profiles {
    standard {
    }

    docker {
        docker.enabled = true    
        process.container = 'europe-north1-docker.pkg.dev/speech2text-218910/repo/est-asr-pipeline:1.1b'
        params.rootdir = "/opt/est-asr-pipeline"
    }
    
    slurm {
        process.executor = 'slurm'
        process.memory = '10GB'
    
    }
    
}
